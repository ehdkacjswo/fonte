Cleaning up the code incrementally

Refactored for better testability (in progress).
