Refactored the code to have less explicit static state
