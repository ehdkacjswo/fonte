Deflate encoding support

Fixes #556
Fixes #964
