Performance fixes after doing some profiling.
