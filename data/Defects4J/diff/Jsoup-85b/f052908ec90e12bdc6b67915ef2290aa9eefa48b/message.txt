Make http charset detection code more robust

Fixes #321
