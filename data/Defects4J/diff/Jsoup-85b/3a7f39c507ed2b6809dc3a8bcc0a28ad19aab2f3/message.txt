Fixed an issue where unexpected elements in a badly nested table could be moved to the wrong location in the document.

Fixes #552
Closes #591
