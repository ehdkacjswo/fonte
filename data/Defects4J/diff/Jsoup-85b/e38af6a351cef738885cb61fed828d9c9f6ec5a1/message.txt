Threadlocal encoder

Fixes #970
