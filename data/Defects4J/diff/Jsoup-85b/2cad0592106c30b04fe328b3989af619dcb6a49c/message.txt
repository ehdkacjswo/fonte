Handle UTF headers and encode URLs better

Fixes #706
