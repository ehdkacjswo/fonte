Re-arrange type resolution to handle IIFEs better
R=blickly
