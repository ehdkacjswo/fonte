COMPRESS-382 and COMPRESS-386 -- take 4, clean up and allow
for overflow via longs.
