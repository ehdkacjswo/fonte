Inline position computation. This is uglier but faster.
