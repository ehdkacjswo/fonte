Code cleanup and some minor performance fixes.
