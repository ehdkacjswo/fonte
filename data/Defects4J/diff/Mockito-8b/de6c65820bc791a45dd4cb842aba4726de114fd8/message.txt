Avoided a singleton.

Reworked the code so that we can avoid more singletons. It also fixes a failing test.
